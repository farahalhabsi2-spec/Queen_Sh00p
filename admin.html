<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة الإدارة - كوين شوب</title>
  <style>
    body { font-family: Tahoma, sans-serif; background:#fff0f8; margin:0; padding:20px; }
    h2 { color:#e60073; text-align:center; }

    .controls {
      display:flex; justify-content:center; align-items:center;
      flex-wrap:wrap; gap:15px; margin:15px 0;
    }
    select, input {
      padding:6px 12px; border-radius:6px; border:1px solid #ccc;
    }
    input { width:200px; }

    .stats { 
      text-align:center; margin:20px auto; 
      background:#fff; padding:15px; border-radius:10px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1); 
      max-width:600px;
    }
    .stats p { margin:8px 0; font-weight:bold; color:#444; }

    table {
      width:100%; border-collapse:collapse; margin-top:20px; background:#fff;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    th, td { border:1px solid #ddd; padding:10px; text-align:center; font-size:14px; }
    th { background:#e60073; color:#fff; }
    tr:nth-child(even) { background:#ffe6f0; }
    .items { text-align:right; font-size:13px; }
    .new { background:#d4f7d4 !important; }

    .buttons { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin-top:20px; }
    .btn {
      padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:bold;
      color:#fff;
    }
    .btn-clear { background:#e60073; }
    .btn-clear:hover { background:#c60060; }
    .btn-export { background:#007bff; }
    .btn-export:hover { background:#0056b3; }
    .btn-excel { background:#28a745; }
    .btn-excel:hover { background:#1e7e34; }
  </style>
</head>
<body>

  <h2>📋 جميع الطلبات - كوين شوب</h2>
  
  <div class="controls">
    <label>📌 عرض:</label>
    <select id="filterSelect">
      <option value="all">كل الطلبات</option>
      <option value="today">طلبات اليوم</option>
      <option value="week">طلبات هذا الأسبوع</option>
      <option value="month">طلبات هذا الشهر</option>
    </select>
    <input type="text" id="searchInput" placeholder="🔍 ابحث بالاسم أو الهاتف">
  </div>

  <!-- ✅ إحصائيات -->
  <div class="stats" id="stats">
    <p>📦 عدد الطلبات: 0</p>
    <p>💵 إجمالي المبيعات: 0 ر.ع</p>
    <p>📊 متوسط قيمة الطلب: 0 ر.ع</p>
    <p>🛍️ عدد المنتجات المباعة: 0</p>
  </div>

  <div class="buttons">
    <button class="btn btn-clear" id="clearOrders">🗑️ مسح كل الطلبات</button>
    <button class="btn btn-export" id="exportOrders">⬇️ تنزيل (CSV)</button>
    <button class="btn btn-excel" id="exportExcel">⬇️ تنزيل (Excel)</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>🆔 رقم الطلب</th>
        <th>🛍️ المنتجات</th>
        <th>💵 الإجمالي</th>
        <th>👤 الزبون</th>
        <th>📞 الهاتف</th>
        <th>📍 العنوان</th>
        <th>💳 الدفع</th>
        <th>⏰ التاريخ</th>
      </tr>
    </thead>
    <tbody id="ordersTable"></tbody>
  </table>

  <!-- مكتبة Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    const ordersTable = document.getElementById("ordersTable");
    const statsBox = document.getElementById("stats");
    const filterSelect = document.getElementById("filterSelect");
    const searchInput = document.getElementById("searchInput");

    let orders = JSON.parse(localStorage.getItem("allOrders")) || [];

    function filterOrders(type) {
      const now = new Date();
      return orders.filter(order => {
        const orderDate = new Date(order.date);
        if (type === "today") {
          return orderDate.toDateString() === now.toDateString();
        } else if (type === "week") {
          const startOfWeek = new Date(now);
          startOfWeek.setDate(now.getDate() - now.getDay());
          return orderDate >= startOfWeek;
        } else if (type === "month") {
          return orderDate.getMonth() === now.getMonth() &&
                 orderDate.getFullYear() === now.getFullYear();
        }
        return true;
      });
    }

    function renderOrders(type="all", search="") {
      const filtered = filterOrders(type).filter(order =>
        order.name.includes(search) || order.phone.includes(search)
      );
      ordersTable.innerHTML = "";
      if (filtered.length === 0) {
        statsBox.innerHTML = "<p>🚫 لا توجد طلبات</p>";
        ordersTable.innerHTML = `<tr><td colspan="8">🚫 لا توجد طلبات</td></tr>`;
        return;
      }

      // حساب الإحصائيات
      let totalSales = 0;
      let productCount = 0;
      filtered.forEach(order => {
        totalSales += parseFloat(order.total);
        productCount += order.items.length;
      });
      const avgOrder = (totalSales / filtered.length).toFixed(2);

      statsBox.innerHTML = `
        <p>📦 عدد الطلبات: ${filtered.length}</p>
        <p>💵 إجمالي المبيعات: ${totalSales.toFixed(2)} ر.ع</p>
        <p>📊 متوسط قيمة الطلب: ${avgOrder} ر.ع</p>
        <p>🛍️ عدد المنتجات المباعة: ${productCount}</p>
      `;

      filtered.forEach(order => {
        const tr = document.createElement("tr");
        if (order.new) tr.classList.add("new");
        tr.innerHTML = `
          <td>${order.orderId || "-"}</td>
          <td class="items">${order.items.map(i => `• ${i.name} - ${i.price} ر.ع`).join("<br>")}</td>
          <td>${order.total} ر.ع</td>
          <td>${order.name}</td>
          <td>${order.phone}</td>
          <td>${order.address}</td>
          <td>${order.payment}</td>
          <td>${order.date}</td>
        `;
        ordersTable.appendChild(tr);
      });
      orders = orders.map(o => ({...o, new:false}));
      localStorage.setItem("allOrders", JSON.stringify(orders));
    }

    filterSelect.addEventListener("change", (e)=> {
      renderOrders(e.target.value, searchInput.value.trim());
    });

    searchInput.addEventListener("input", (e)=> {
      renderOrders(filterSelect.value, e.target.value.trim());
    });

    document.getElementById("clearOrders").addEventListener("click", () => {
      if (confirm("هل أنت متأكد من مسح جميع الطلبات؟")) {
        localStorage.removeItem("allOrders");
        location.reload();
      }
    });

    // CSV
    document.getElementById("exportOrders").addEventListener("click", () => {
      if (orders.length === 0) {
        alert("🚫 لا توجد طلبات للتنزيل");
        return;
      }
      let csvContent = "data:text/csv;charset=utf-8,";
      csvContent += "رقم الطلب,المنتجات,الإجمالي,الزبون,الهاتف,العنوان,الدفع,التاريخ\n";
      orders.forEach(order => {
        const products = order.items.map(i => `${i.name} - ${i.price} ر.ع`).join(" | ");
        csvContent += `${order.orderId || "-"},${products},${order.total},${order.name},${order.phone},${order.address},${order.payment},${order.date}\n`;
      });
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "orders.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    // Excel
    document.getElementById("exportExcel").addEventListener("click", () => {
      if (orders.length === 0) {
        alert("🚫 لا توجد طلبات للتنزيل");
        return;
      }
      const wsData = [
        ["رقم الطلب", "المنتجات", "الإجمالي", "الزبون", "الهاتف", "العنوان", "الدفع", "التاريخ"]
      ];
      orders.forEach(order => {
        const products = order.items.map(i => `${i.name} - ${i.price} ر.ع`).join(" | ");
        wsData.push([order.orderId || "-", products, order.total, order.name, order.phone, order.address, order.payment, order.date]);
      });
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "طلبات");
      XLSX.writeFile(wb, "orders.xlsx");
    });

    renderOrders("all");
  </script>
</body>
</html>

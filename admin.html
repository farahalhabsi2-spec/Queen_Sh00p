<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - ÙƒÙˆÙŠÙ† Ø´ÙˆØ¨</title>
  <style>
    body { font-family: Tahoma, sans-serif; background:#fff0f8; margin:0; padding:20px; }
    h2 { color:#e60073; text-align:center; }

    .controls {
      display:flex; justify-content:center; align-items:center;
      flex-wrap:wrap; gap:15px; margin:15px 0;
    }
    select, input {
      padding:6px 12px; border-radius:6px; border:1px solid #ccc;
    }
    input { width:200px; }

    .stats { 
      text-align:center; margin:20px auto; 
      background:#fff; padding:15px; border-radius:10px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1); 
      max-width:600px;
    }
    .stats p { margin:8px 0; font-weight:bold; color:#444; }

    table {
      width:100%; border-collapse:collapse; margin-top:20px; background:#fff;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    th, td { border:1px solid #ddd; padding:10px; text-align:center; font-size:14px; }
    th { background:#e60073; color:#fff; }
    tr:nth-child(even) { background:#ffe6f0; }
    .items { text-align:right; font-size:13px; }
    .new { background:#d4f7d4 !important; }

    .buttons { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin-top:20px; }
    .btn {
      padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:bold;
      color:#fff;
    }
    .btn-clear { background:#e60073; }
    .btn-clear:hover { background:#c60060; }
    .btn-export { background:#007bff; }
    .btn-export:hover { background:#0056b3; }
    .btn-excel { background:#28a745; }
    .btn-excel:hover { background:#1e7e34; }
  </style>
</head>
<body>

  <h2>ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª - ÙƒÙˆÙŠÙ† Ø´ÙˆØ¨</h2>
  
  <div class="controls">
    <label>ğŸ“Œ Ø¹Ø±Ø¶:</label>
    <select id="filterSelect">
      <option value="all">ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</option>
      <option value="today">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</option>
      <option value="week">Ø·Ù„Ø¨Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</option>
      <option value="month">Ø·Ù„Ø¨Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</option>
    </select>
    <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ">
  </div>

  <!-- âœ… Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
  <div class="stats" id="stats">
    <p>ğŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: 0</p>
    <p>ğŸ’µ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: 0 Ø±.Ø¹</p>
    <p>ğŸ“Š Ù…ØªÙˆØ³Ø· Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨: 0 Ø±.Ø¹</p>
    <p>ğŸ›ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©: 0</p>
  </div>

  <div class="buttons">
    <button class="btn btn-clear" id="clearOrders">ğŸ—‘ï¸ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
    <button class="btn btn-export" id="exportOrders">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ (CSV)</button>
    <button class="btn btn-excel" id="exportExcel">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ (Excel)</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>ğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
        <th>ğŸ›ï¸ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</th>
        <th>ğŸ’µ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
        <th>ğŸ‘¤ Ø§Ù„Ø²Ø¨ÙˆÙ†</th>
        <th>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ</th>
        <th>ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
        <th>ğŸ’³ Ø§Ù„Ø¯ÙØ¹</th>
        <th>â° Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
      </tr>
    </thead>
    <tbody id="ordersTable"></tbody>
  </table>

  <!-- Ù…ÙƒØªØ¨Ø© Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    const ordersTable = document.getElementById("ordersTable");
    const statsBox = document.getElementById("stats");
    const filterSelect = document.getElementById("filterSelect");
    const searchInput = document.getElementById("searchInput");

    let orders = JSON.parse(localStorage.getItem("allOrders")) || [];

    function filterOrders(type) {
      const now = new Date();
      return orders.filter(order => {
        const orderDate = new Date(order.date);
        if (type === "today") {
          return orderDate.toDateString() === now.toDateString();
        } else if (type === "week") {
          const startOfWeek = new Date(now);
          startOfWeek.setDate(now.getDate() - now.getDay());
          return orderDate >= startOfWeek;
        } else if (type === "month") {
          return orderDate.getMonth() === now.getMonth() &&
                 orderDate.getFullYear() === now.getFullYear();
        }
        return true;
      });
    }

    function renderOrders(type="all", search="") {
      const filtered = filterOrders(type).filter(order =>
        order.name.includes(search) || order.phone.includes(search)
      );
      ordersTable.innerHTML = "";
      if (filtered.length === 0) {
        statsBox.innerHTML = "<p>ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>";
        ordersTable.innerHTML = `<tr><td colspan="8">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>`;
        return;
      }

      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
      let totalSales = 0;
      let productCount = 0;
      filtered.forEach(order => {
        totalSales += parseFloat(order.total);
        productCount += order.items.length;
      });
      const avgOrder = (totalSales / filtered.length).toFixed(2);

      statsBox.innerHTML = `
        <p>ğŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: ${filtered.length}</p>
        <p>ğŸ’µ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: ${totalSales.toFixed(2)} Ø±.Ø¹</p>
        <p>ğŸ“Š Ù…ØªÙˆØ³Ø· Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨: ${avgOrder} Ø±.Ø¹</p>
        <p>ğŸ›ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©: ${productCount}</p>
      `;

      filtered.forEach(order => {
        const tr = document.createElement("tr");
        if (order.new) tr.classList.add("new");
        tr.innerHTML = `
          <td>${order.orderId || "-"}</td>
          <td class="items">${order.items.map(i => `â€¢ ${i.name} - ${i.price} Ø±.Ø¹`).join("<br>")}</td>
          <td>${order.total} Ø±.Ø¹</td>
          <td>${order.name}</td>
          <td>${order.phone}</td>
          <td>${order.address}</td>
          <td>${order.payment}</td>
          <td>${order.date}</td>
        `;
        ordersTable.appendChild(tr);
      });
      orders = orders.map(o => ({...o, new:false}));
      localStorage.setItem("allOrders", JSON.stringify(orders));
    }

    filterSelect.addEventListener("change", (e)=> {
      renderOrders(e.target.value, searchInput.value.trim());
    });

    searchInput.addEventListener("input", (e)=> {
      renderOrders(filterSelect.value, e.target.value.trim());
    });

    document.getElementById("clearOrders").addEventListener("click", () => {
      if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§ØªØŸ")) {
        localStorage.removeItem("allOrders");
        location.reload();
      }
    });

    // CSV
    document.getElementById("exportOrders").addEventListener("click", () => {
      if (orders.length === 0) {
        alert("ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„ØªÙ†Ø²ÙŠÙ„");
        return;
      }
      let csvContent = "data:text/csv;charset=utf-8,";
      csvContent += "Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨,Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª,Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ,Ø§Ù„Ø²Ø¨ÙˆÙ†,Ø§Ù„Ù‡Ø§ØªÙ,Ø§Ù„Ø¹Ù†ÙˆØ§Ù†,Ø§Ù„Ø¯ÙØ¹,Ø§Ù„ØªØ§Ø±ÙŠØ®\n";
      orders.forEach(order => {
        const products = order.items.map(i => `${i.name} - ${i.price} Ø±.Ø¹`).join(" | ");
        csvContent += `${order.orderId || "-"},${products},${order.total},${order.name},${order.phone},${order.address},${order.payment},${order.date}\n`;
      });
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "orders.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    // Excel
    document.getElementById("exportExcel").addEventListener("click", () => {
      if (orders.length === 0) {
        alert("ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„ØªÙ†Ø²ÙŠÙ„");
        return;
      }
      const wsData = [
        ["Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨", "Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª", "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ", "Ø§Ù„Ø²Ø¨ÙˆÙ†", "Ø§Ù„Ù‡Ø§ØªÙ", "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†", "Ø§Ù„Ø¯ÙØ¹", "Ø§Ù„ØªØ§Ø±ÙŠØ®"]
      ];
      orders.forEach(order => {
        const products = order.items.map(i => `${i.name} - ${i.price} Ø±.Ø¹`).join(" | ");
        wsData.push([order.orderId || "-", products, order.total, order.name, order.phone, order.address, order.payment, order.date]);
      });
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Ø·Ù„Ø¨Ø§Øª");
      XLSX.writeFile(wb, "orders.xlsx");
    });

    renderOrders("all");
  </script>
</body>
</html>
